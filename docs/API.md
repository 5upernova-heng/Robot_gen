# 架构设计与接口定义

本项目是一个 CS 架构的项目，使用 RestAPI 进行前后端通信。

这里对前后端通信用到的接口进行定义。

## 架构设计

本项目需要实现一个基于 DSL 的客服机器人生成器。需要定义生成机器人的语法规则，并编写程序解释 + 生成对话机器人。并顺带实现和机器人的对话功能。

一个常规的流程是：

1. 用户通过使用 DSL 编写机器人脚本
2. 交给程序生成一个机器人，并提供对话交互界面
3. 用户通过交互界面与机器人交流

由于脚本解析、生成的机器人逻辑都在后端，所以重点在于：

1. 如何将用户的脚本上传到后端进行解析，并生成对应机器人
2. 如何实现用户在前端实时地与机器人沟通。

第一点，由于本项目使用 Electron 桌面架构，所以其提供了访问本地文件的接口
第二点：后端始终存储用户与机器人的聊天记录，每次用户输入一句话，会在交给机器人的同时，保存一份聊天记录。返回的是一个对话（用户输入与机器人回应）

在实际的用途中，这个程序应该是 ToB 的。也就是说，机器人的脚本由企业内部人员编写，编写完成后负责维护。客户只能通过前端选择与机器人进行对话。
所以考虑到并发的可能性：

1. 用户会同时和多个机器人进行对话，于是对应的 HTTP 请求中应该带有唯一标识机器人，为保证顺序正确，还需要带上时间戳。
2. 另一层面的并发是，多个用户和同一个机器人对话。这就需要同一个机器人能够制造多份复制。

因此本项目将机器人构造的过程抽象成了一个“工厂模式”——脚本定义的是一个“机器人工厂”，而机器人本身是实例对象，可以被无限次数地构造，且实例之间不会互相影响。

用户连接到机器人的时候，只需要指名机器人的名字，然后由系统创建一个机器人实例，并给予一个 session_token，用于后续的通信。

从用户输入到机器人回应存在时间。所以最好的方式是，当后端得到机器人的回复之后，通知前端进行更新。这里可以使用 WebSocket
直接将更新推送到前端。

## 流程描述

用户输入文本 —— 根据其选择的机器人，交给后端特定的机器人，开放 Socket —— 后端得到输出，将结果通过 Socket 推送给前端 —— 前端显示

# 接口定义

## GET 根据模板创建机器人实例

GET /create-instance

### 请求参数

| 名称  | 位置    | 类型     | 说明               |
|-----|-------|--------|------------------|
| bid | query | string | 机器人 schema 的 bid |

### 返回示例

```json
{
  "code": 1,
  "msg": "Call robot success"
}
```

### 返回数据结构

状态码 **200**

| 名称               | 类型     | 必选   | 说明          |
|------------------|--------|------|-------------|
| » instance_token | string | true | 机器人实例 token |

## GET 列出所有机器人模板

GET /list

### 返回示例

```json
{
  "robots": [
    {
      "name": "string",
      "bid": "string",
      "description": "string"
    }
  ]
}
```

### 返回数据结构

状态码 **200**

| 名称             | 类型                            | 必选   | 说明          |
|----------------|-------------------------------|------|-------------|
| » robots       | [[RobotSchema](#RobotSchema)] | true | 可用机器人       |
| »» name        | string                        | true | 机器人名字       |
| »» bid         | string                        | true | 唯一标识机器人的 ID |
| »» description | string                        | true | none        |

## 数据结构

### RobotSchema

机器人范式。由脚本定义，可以通过 Schema 创造机器人实例（RobotInstance）

```json
{
  "name": "string",
  "bid": "string",
  "description": "string"
}

```

### 属性

| 名称          | 类型     | 必选   | 说明          |
|-------------|--------|------|-------------|
| name        | string | true | 机器人名字       |
| bid         | string | true | 唯一标识机器人的 ID |
| description | string | true | none        |



