# DSL 语言设计

## 概述

DSL 设计的是一个应答机器人，在程序中叫做 Chatbot。Chatbot 本质上是一个有限状态自动机。其由多个状态构成，并且每个状态之间可以互相转移。

在每个状态中，应答机器人会根据用户输入，做出回答，并且隐式地在状态之间转移。

一个 Chatbot 由多个状态（state）构成
而一个状态由多个场景（scenario）构成
每个场景都是一个 List[str] -> Action 的映射，即通过搜索关键词，做出定义的动作（Action）
Action 包含回复和状态转移。二者并不冲突，一个动作可能在即做出回复的时候，又完成了状态转移。

> <h3>为什么需要状态 State</h3>
>
> 加入了状态以及状态转移之后，聊天机器人实际上已经变成了一个图灵机。而脚本就是纸带。由此可以编写一些更复杂的逻辑。比如同一个单词，在不同的语境下可能需要得到不同的回复。
> 比如我们为移动通信运营商设计聊天机器人，这个机器人既需要查询话费，又需要查询流量。
>
> 而在现实场景中，用户的对话一定是上下文相关的。比如，用户首先询问了话费套餐，如果此时用户问“我当前是什么套餐”，显然，机器人合理的回答应该是用户当前的
**话费**套餐。而如果用户首先询问了流量相关事宜，那么同一个问题，此处就应回答用户当前的**流量**套餐。
>
> 上面这个例子说明了状态的必要性。因为状态可以储存信息，从而让机器人一定程度地记住上下文，让回答更智能。

## 详细介绍

### 综述

机器人的行为通过一个深度嵌套的字典（键值对集合）进行定义。而定义字典的语法与 [YAML ](https://yaml.org/)完全一致。

在 YAML 的基础上，本程序会对键值对的键名做出更严格的限制。

> 在程序中，只有有效的键会被读取，其余的键会被舍弃。因此，通过添加无效键值对的方式，给机器人脚本添加注释。例如：
>
> ```yaml
> name: demo robot
> states: ...
> doc: 这是一个机器人
> ```
>
> 另外，所有有效的键都必须出现，否则将导致解析失败。本程序自定义异常 `KeyNotFoundError` 用来表示这一错误。在报错的同时，会提醒具体确实了哪个
> key

最顶层中，只有 name 和 states 键是有效的，因此，我们可以添加类似 doc 的无效键，来为机器人添加必要的说明

接下来将从最原子的键值对出发，向上逐个介绍每一层的键值对，及其意义。

### Action 动作

Action 定义了机器人可能的动作。
Action 包含两个有效键：

| key    | value | 说明                           |
|--------|-------|------------------------------|
| reply  | 字符串   | 机器人做出回复。value 即为回复内容         |
| switch | 字符串   | 机器人切换状态。value 为目标状态的名字（name） |

一个 Action 至少包含两个有效 key 的任何一个，允许同时包含两个 key

### Triggers 触发条件

Triggers 定义了执行 Action 的触发条件。具体表现为一个字符串数组。只要数组中的字符串的**任意一条**出现在了用户输入中，即视为触发。
Triggers 的长度至少为 1

### Scenario 情景

Scenario 定义了一个情景，在一个情景中，机器人会监听用户输入，判断是否触发条件。如果触发则会执行相应的动作。
Scenario 包含两个有效键：

| key      | value     | 说明                |
|----------|-----------|-------------------|
| triggers | 字符串数组     | 该情境下的触发条件         |
| action   | action 动作 | 如果条件触发，机器人应该执行的动作 |

### State 状态

State 定义了机器人的状态。状态包含两个有效键：

| key       | value          | 说明                            |
|-----------|----------------|-------------------------------|
| name      | 字符串            | 状态的名字。不允许重名。用于 Action 状态转移    |
| scenarios | List[Scenario] | 场景构成的集合                       |
| default   | 字符串            | 默认回复。如果用户输入没有触发任何场景，那么将进行默认回复 |

### Robot 机器人

Robot 包含五个有效键

| key         | value       | 说明                  |
|-------------|-------------|---------------------|
| name        | 字符串         | 机器人的名字              |
| description | 字符串         | 机器人用途的描述            |
| states      | List[State] | 状态集合                |
| initial     | State       | 初始状态                |
| opening     | 字符串         | 开场白，创建机器人之后会立刻发送给用户 |

## 示例

下面是一个脚本示例，模拟的是一个提供简单查询功能的教学用机器人：

```yaml
name: 助教机器人
description: 助教机器人，可以进行简单的查询服务
initial: start
opening: 同学你好，我是助教机器人，可以为你查询课后作业、课程成绩等相关信息
states:
  - name: start
    default: 对不起，目前没有这个功能
    scenarios:
      - triggers:
          - 成绩
          - 学分
          - 绩点
        action:
          reply:
            同学，你的课程成绩是 XXX
      - triggers:
          - 作业
        action:
          reply:
            目前的课后作业是 XXX
      - triggers:
          - 联系老师
        action:
          reply:
            老师的联系方式是 XXX
      - triggers:
          - 意见
          - 建议
        action:
          reply:
            感谢同学的宝贵意见，我们会做得更好

```

- 这个机器人的开场白是：“同学你好，我是助教机器人，可以为你查询课后作业、课程成绩等相关信息”
- 其只有一个状态。
    - 输入“成绩/学分/绩点”时，其会回复“同学，你的课程成绩是 XXX”
    - 输入“作业”时，其会回复“目前的课后作业是 XXX”
    - 输入“意见/建议”时，其会回复“感谢同学的宝贵意见，我们会做得更好”
    - 其他情况下，会回复“对不起，目前没有这个功能”
